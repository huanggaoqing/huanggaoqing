---
title: 暗夜模式实现
date: 2023-10-15 00:57:58
permalink: /pages/9c1e1f/
categories:
  - 技术
  - Electron
tags:
  - Vue
  - TypeScript
  - Electron
  - CSS
author: 
  name: huanggaoqing
  link: https://github.com/huanggaoqing
---
![控制流程图](/img/theme.png)
## 几个主要模块
### 主题控制器
```typescript
import { computed, ref, onBeforeMount } from "vue";
import { setLocalStorage, getLocalStorage } from "@/localStorage"
import { CURRENT_THEME } from "@/localStorage/localStorageKeys"

const useThemeController = () => {
    // light, dark
    const theme = ref("light")

    const defaultName = "light";
        
    return () => {
        onBeforeMount(() => {
            setTheme(getTheme())
            // 需要根据设备主题颜色变换时打开
            // handleSystemTheme()
        })
    
        let isDark = computed(() => theme.value === "dark");

        // 获取主题颜色 js中使用主题颜色时用这个方法获取
        function getThemeColor(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(`--${name}`);
        }

        // 设置主题颜色 js中动态改变主题中颜色使用的方法
        function setThemeColor(name, color) {
            getComputedStyle(document.documentElement).setProperty(`--${name}`, color);
        }
    
        const setTheme = (val) => {
            theme.value = val
            setLocalStorage(CURRENT_THEME, val)
            document.documentElement.setAttribute('data-theme', val);
        };
    
        const getTheme = () => getLocalStorage(CURRENT_THEME) || defaultName;
    
        // 根据系统设置切换主题
        function handleSystemTheme() {
            const media = window.matchMedia('(prefers-color-scheme: dark)')
            media.addEventListener('change', (e) => {
                if (e.matches) {
                    setTheme('dark')
                } else {
                    setTheme('light')
                }
            })
        }
        
        return {
            theme,
            setTheme,
            isDark,
            getThemeColor,
            setThemeColor
        };
    }
}

export default useThemeController()
```
通过主题控制器，对外暴露的方法可以去切换、获取主题。细节上不同主题的调整也可以使用对外暴露的isDark或者theme判断并作出相应的处理。（尽量减少使用，因为使用起来比较分散，不好维护）
### css主题色配置
通过css变量的方式配置不同主题下的颜色值。分为系统颜色配置、element组件颜色配置。（尽量把颜色值配置在系统主题配置文件中，element主题配置文件中再去使用配置好的变量）
主要是根据在根元素上设置的data-theme属性去切换不同的颜色配置
### 不同主题的icon配置
```typescript
import useThemeController from "../useThemeController";
import {watchEffect, ref} from "vue";

const iconMap = new Map([
  ["light", require("./light").default],
  ["dark", require("./dark").default]
])

/**
 * Get the corresponding theme icon
 *
 * @param {string} key - The key to retrieve the icon.
 * @param {any} defaultValue - The default value when the icon is not found.
 * @return {any} corresponding icon data.
 */
function useGetIcon(key, defaultValue) {
  const {theme} = useThemeController();
  const data = ref(defaultValue)
  watchEffect(() => {
    data.value = iconMap.get(theme.value)?.[key] ?? defaultValue
  })
  return data
}

export default useGetIcon
```

通过主题控制器中暴露的theme方法，去读取不同配置文件，再通过key值取到想要的icon数据。

**注意：尽量都使用配置文件的方式去适配多主题，以便维护，实在难以避免再使用通过isDrak或者theme的方式适配**
