---
title: electron使用ffmpeg-static
date: 2023-10-25 21:08:36
permalink: /pages/877c8f/
categories:
  - 技术
  - Electron
tags:
  - Electron
  - ffmpeg
author: 
  name: huanggaoqing
  link: https://github.com/huanggaoqing
---
# electron 使用 ffmpeg-static

## 问题：

Electron默认是开启asar的，导致二进制文件也被打在了asar文件中，就不能再被调用，所以我们要让二进制文件不被处理。

## 解决方式

需要使用 `extraResources` 将二进制文件复制到应用程序包中，并且要兼容不同平台

1. 获取到不同平台下的执行文件路径
    
    ```jsx
    function getFfmpegPath () {
      const ffmpegBasePath = "node_modules/ffmpeg-static/";
      const { platform } = process;
      const ffmpegPathMap = {
        darwin: "ffmpeg",
        win32: "ffmpeg.exe",
        win64: "ffmpeg.exe",
        linux32: "ffmpeg",
        linux64: "ffmpeg"
      };
      return ffmpegBasePath + ffmpegPathMap[platform];
    }
    ```
    
2. 打包时复制文件到应用程序包中
    
    ```jsx
    plugins: [
    	...
      new CopyWebpackPlugin({
        patterns: [{
          from: path.join(__dirname, getFfmpegPath()),
          to: path.join(__dirname, "core"),
          // ignore: [".*"]
          globOptions: {
            ignore: [".*"]
          }
        }]
      }),
    	...
    ]
    builderOptions: {
    	...
    	extraResources: {
    	  from: "./core/",
    	  to: "./core/",
    	  filter: ["**/*"]
    	}
    	...
    }
    ```
    
3. 使用
    
    ```tsx
    //根据开发环境获取执行文件路径
    function getFfmpegExe () {
      let ffmpegPath = "";
      // 更新打包后 ffmpeg 路径
      if (process.env.NODE_ENV === "production") {
          ffmpegPath = resolve(__dirname, "../core/ffmpeg");
      } else {
          const { platform } = process;
          const ffmpegPathMap = {
              darwin: "ffmpeg",
              win32: "ffmpeg.exe",
              win64: "ffmpeg.exe",
              linux32: "ffmpeg",
              linux64: "ffmpeg"
          };
          ffmpegPath = resolve(
              __dirname,
              "../../../../..",
              "ffmpeg-static",
              ffmpegPathMap[platform]
          );
      }
      return ffmpegPath
    }
    
    // 使用
    const ffPath = getFfmpegExe()
    const inputFilePath = "C:\\Users\\33597\\Music\\test\\video\\720\\test_video.mp4";
    const outputFilePath = inputFilePath.replace('.mp4', '.m4v');
    console.log({inputFilePath, outputFilePath})
    // 执行FFmpeg命令
    execFile(ffPath, ["-i", inputFilePath, outputFilePath], (error, stdout, stderr) => {
      if (error) {
        console.error(`FFmpeg执行错误：${error}`);
        return;
      }
      console.log('音频转码完成！');
    });
    ```
