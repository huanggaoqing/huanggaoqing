---
title: Pinia持久化插件
date: 2023-11-19 15:49:58
permalink: /pages/c522d2/
categories:
  - 技术
  - Vue
tags:
  - 
author: 
  name: huanggaoqing
  link: https://github.com/huanggaoqing
---
## 插件代码，通过读取配置实现不同方式的持久化

```tsx
import config from "./config"

export default function storePlugin({store}) {
	console.log("storePlugin", {store: store, config: config});
	const keys = Object.keys(config.store)
	if (keys.includes(store.$id)) {
	  const storeMrg = config.store[store.$id] === "session" ? sessionStorage : localStorage
	  const key = config.prefix + "_" + store.$id
	  if (!storeMrg.getItem(key)) {
	    storeMrg.setItem(key, JSON.stringify(store.$state))
	  }
	  store.$subscribe(() => {
	    storeMrg.setItem(key, JSON.stringify(store.$state))
	  })
	  return storeMrg.getItem(key) ? JSON.parse(localStorage.getItem(key)) : store.$state
	}
	return store.$state
}
```

## 配置文件

```tsx
import { STORE_ID as setting_store_id } from "@/piniaStore/store/setting.store"

export default {
  // 持久化key值前缀
  prefix: "pinia",
  // 需要持久化的store在这里配置
  // 格式：store id: 持久化方式 session|local
  store: {
    [setting_store_id]: "local"
  }
}
```

## 使用

初始化pinia时使用 `use` 使用插件

```jsx
import { createPinia } from "pinia"
import storePlugin from "./piniaStore/plugin/store.plugin";

const pinia = createPinia();
pinia.use(storePlugin)

const app = createApp(App)
app.use(pinia).mount("#app")
```

store代码

```jsx
import { defineStore } from "pinia"

export const STORE_ID = "setting"

const useSettingStore = defineStore(STORE_ID, {
  state() {
    return {
      isDark: true
    }
  }
})

export default useSettingStore
```

## 实现效果

在缓存中会存储一个pinia前缀开头的数据，该数据也会随着store的变化而变化。

![Untitled](/img/demo.png)
